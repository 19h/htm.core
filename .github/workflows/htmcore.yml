name: htm.core build

on:
  push:
    branches:
      - v*\.*\.*\.* # vX.Y.Z release tag
  # run on pull_request events that target the master branch
  pull_request:
    branches:
    - master
  # run every day of the week from Monday - Friday at 02:00
  schedule:
  - cron: 0 2 * * 1-5
      
jobs:
  build:
    name: Building on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      #max-parallel: 4
      matrix:
        python-version: [3.7]
        os: [ubuntu-18.04, windows-2019, macOS-latest, ubuntu-latest]
        # ubuntu-latest is used for valgrind and Debug build

    steps:
    - uses: actions/checkout@v1

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v1
      with:
        python-version: ${{ matrix.python-version }}

    - name: Config
      run: |
        python --version
        cmake --version

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r requirements.txt

    - name: build htmcore with setup.py
      if: matrix.os != 'ubuntu-latest'
      run: |
        python setup.py install --user

    - name: Debug build htmcore with setup.py
      if: matrix.os == 'ubuntu-latest'
      env:
        CMAKE_BUILD_TYPE: Debug
      run: |
        echo "built type: ${CMAKE_BUILD_TYPE}"
        python setup.py install --user

    - name: C++ & Python Tests
      run: python setup.py test
      
    - name: Memory leaks check (valgrind)
      if: success() && matrix.os == 'ubuntu-latest'
      run:
        sudo apt-get -y install valgrind
        LD_LIBRARY_PATH=${LD_LIBRARY_PATH}:${PWD}/build/Release/lib valgrind  --show-leak-kinds=definite,indirect,possible,reachable --track-origins=yes --num-callers=40 --error-exitcode=3 ./build/Release/bin/benchmark_hotgym 5 || exit 1

  build-arm64-docker:
    name: Build for ARM64 on Docker
    runs-on: ubuntu-18.04
    steps:
      - name: Docker ARM64 image
        run: |
          # bug in ubuntu, conflicts with docker.io
          sudo apt-get update
          sudo apt-get remove --purge -y moby-engine moby-cli
          sudo apt-get install -y qemu-system docker.io
          uname -a
          sudo docker run --rm --privileged multiarch/qemu-user-static:register --reset
          uname -a
          
      - uses: actions/checkout@v1
      - name: ARM64 build
        run: |
          sudo docker build -t htm-arm64-docker --build-arg arch=arm64 .
          uname -a

      #TODO GH Releases
      #TODO PYPI deploy
